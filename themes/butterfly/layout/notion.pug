extends includes/layout.pug

block content
  #page.notion-page.hide-aside
    if top_img === false
      h1.page-title= page.title

    - 
      // Notion 颜色映射函数
      function getNotionColor(color) {
        const colorMap = {
          'default': { bg: '#e0e0e0', text: '#37352f' },
          'gray': { bg: '#e0e0e0', text: '#37352f' },
          'brown': { bg: '#eee0da', text: '#64473a' },
          'orange': { bg: '#fadec9', text: '#d9730d' },
          'yellow': { bg: '#fdecc8', text: '#cb912f' },
          'green': { bg: '#dbeddb', text: '#448361' },
          'blue': { bg: '#d3e5ef', text: '#337ea9' },
          'purple': { bg: '#e8deee', text: '#9065b0' },
          'pink': { bg: '#f5e0e9', text: '#c14c8a' },
          'red': { bg: '#ffe2dd', text: '#d44c47' }
        };
        return colorMap[color] || colorMap['default'];
      }

      // 收集所有年份并按年份分组数据,同时记录每个年份的颜色
      var itemsByYear = {};
      var yearColors = {};
      if (page.items && page.items.length > 0) {
        page.items.forEach(function(item) {
          var yearValue = getPropertyValue(item, '年份');
          var year = '';
          var yearColor = 'default';
          if (yearValue) {
            if (Array.isArray(yearValue)) {
              if (yearValue.length > 0 && yearValue[0]) {
                year = yearValue[0].name || yearValue[0];
                yearColor = yearValue[0].color || 'default';
              } else {
                year = '未分类';
              }
            } else if (typeof yearValue === 'object' && yearValue.name) {
              year = yearValue.name;
              yearColor = yearValue.color || 'default';
            } else {
              year = yearValue;
            }
          } else {
            year = '未分类';
          }
          if (!itemsByYear[year]) {
            itemsByYear[year] = [];
            yearColors[year] = yearColor;
          }
          itemsByYear[year].push(item);
        });
      }
      var years = Object.keys(itemsByYear).sort().reverse();

    #notion-content
      .notion-database-container
        if years.length > 0
          .notion-columns
            each year in years
              - var yearColorObj = getNotionColor(yearColors[year])
              .year-column
                .year-header(style=`background-color: ${yearColorObj.bg}; color: ${yearColorObj.text};`)= year
                .year-items
                  each item in itemsByYear[year]
                    -
                      // 使用年份分类颜色作为卡片背景色,添加70%透明度
                      var cardBgColor = yearColorObj.bg.replace(')', ', 0.7)').replace('rgb', 'rgba');
                      var cardBorderColor = yearColorObj.text;
                      
                      // 如果颜色是十六进制格式,转换为rgba
                      if (cardBgColor.startsWith('#')) {
                        var r = parseInt(cardBgColor.slice(1, 3), 16);
                        var g = parseInt(cardBgColor.slice(3, 5), 16);
                        var b = parseInt(cardBgColor.slice(5, 7), 16);
                        cardBgColor = `rgba(${r}, ${g}, ${b}, 0.7)`;
                      }
                    .notion-item.card-widget(style=`background-color: ${cardBgColor}; border-color: ${cardBorderColor};`)
                      if item.coverImage
                        .item-cover
                          img(src=item.coverImage alt='封面图片' loading='lazy')
                      .item-header
                        - var titleProp = page.config.title_property || 'Name'
                        h3.item-title
                          if item.url
                            a(href=item.url target='_blank' rel='noopener noreferrer')= getPropertyValue(item, titleProp) || '无标题'
                          else
                            = getPropertyValue(item, titleProp) || '无标题'
                      
                      .item-content
                        - var displayProps = page.config.display_properties || []
                        if displayProps.length > 0
                          each prop in displayProps
                            - var value = getPropertyValue(item, prop)
                            .property-row
                              .property-label= prop + ':'
                              .property-value
                                if !value || (isArray(value) && value.length === 0)
                                  span.empty -
                                else if isArray(value)
                                  each val in value
                                    if val
                                      - var tagColor = getNotionColor(val.color || 'default')
                                      span.tag(style=`background-color: ${tagColor.bg}; color: ${tagColor.text};`)= val.name || val
                                else if typeof value === 'boolean'
                                  span.checkbox= value ? '✓' : '✗'
                                else if typeof value === 'object' && value !== null && value.name
                                  - var tagColor = getNotionColor(value.color || 'default')
                                  span.tag(style=`background-color: ${tagColor.bg}; color: ${tagColor.text};`)= value.name
                                else
                                  = value
                        else
                          // 如果没有指定显示属性,显示所有属性
                          each value, key in item
                            if key !== 'id' && key !== 'url' && value
                              .property-row
                                .property-label= key + ':'
                                .property-value
                                  if isArray(value)
                                    each val in value
                                      if val
                                        - var tagColor = getNotionColor(val.color || 'default')
                                        span.tag(style=`background-color: ${tagColor.bg}; color: ${tagColor.text};`)= val.name || val
                                  else if typeof value === 'boolean'
                                    span.checkbox= value ? '✓' : '✗'
                                  else if typeof value === 'object' && value !== null && value.name
                                    - var tagColor = getNotionColor(value.color || 'default')
                                    span.tag(style=`background-color: ${tagColor.bg}; color: ${tagColor.text};`)= value.name
                                  else if key === 'createdTime' || key === 'lastEditedTime'
                                    = formatNotionTime(value)
                                  else
                                    = value

                      .item-footer
                        .item-meta
                          if item.createdTime
                            span.created-time
                              i.far.fa-calendar-alt
                              = ' 创建于 ' + formatNotionDate(item.createdTime)
                          if item.lastEditedTime
                            span.updated-time
                              i.far.fa-edit
                              = ' 更新于 ' + formatNotionDate(item.lastEditedTime)
        else
          .no-data
            p 暂无数据

    style.
      /* 隐藏右侧边栏 */
      .notion-page.hide-aside ~ .aside-content {
        display: none !important;
      }
      
      /* 调整 content-inner 宽度 - 左侧留空白 */
      #content-inner {
        max-width: 100% !important;
        width: 100% !important;
        padding: 0 0 0 40px !important;
      }
      
      .notion-page.hide-aside {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      #page.hide-aside {
        padding: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      .notion-page {
        padding: 20px 0;
      }
      
      .notion-database-container {
        max-width: 100%;
        margin: 0;
        padding: 20px 8px 8px 8px;
        overflow-x: auto;
        overflow-y: hidden;
        /* 滚动条在顶部 */
        transform: rotateX(180deg);
      }
      
      .notion-columns {
        /* 抵消容器的翻转 */
        transform: rotateX(180deg);
      }
      
      /* 自定义滚动条样式 - 加粗 */
      .notion-database-container::-webkit-scrollbar {
        height: 16px;
      }
      
      .notion-database-container::-webkit-scrollbar-track {
        background: var(--card-bg);
        border-radius: 8px;
        margin: 0 8px;
      }
      
      .notion-database-container::-webkit-scrollbar-thumb {
        background: var(--theme-color);
        border-radius: 8px;
        opacity: 0.7;
      }
      
      .notion-database-container::-webkit-scrollbar-thumb:hover {
        background: var(--theme-color);
        opacity: 1;
      }
      
      /* 列式布局容器 */
      .notion-columns {
        display: flex;
        gap: 10px;
        min-width: min-content;
        padding-bottom: 10px;
      }
      
      /* 每个年份列 - 缩小20% */
      .year-column {
        flex: 0 0 auto;
        min-width: 224px;
        max-width: 256px;
      }
      
      /* 年份表头 - 颜色由内联样式控制 */
      .year-header {
        position: sticky;
        top: 60px;
        z-index: 10;
        padding: 10px 14px;
        font-size: 16px;
        font-weight: 700;
        text-align: center;
        border-radius: 8px 8px 0 0;
        margin-bottom: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      /* 该年份的所有卡片 */
      .year-items {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .notion-item {
        /* 背景色由内联样式控制,基于观看状态 */
        border-radius: 6px;
        padding: 10px;
        box-shadow: var(--card-box-shadow);
        transition: all 0.3s ease;
        border: 1px solid;
      }
      
      .notion-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
      }
      
      .item-cover {
        width: 100%;
        height: auto;
        overflow: hidden;
        border-radius: 4px;
        margin-bottom: 8px;
      }
      
      .item-cover img {
        width: 100%;
        height: auto;
        object-fit: contain;
        transition: transform 0.3s ease;
      }
      
      .notion-item:hover .item-cover img {
        transform: scale(1.05);
      }
      
      .item-header {
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--card-border);
      }
      
      .item-title {
        margin: 0;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-color);
        line-height: 1.4;
      }
      
      .item-title a {
        color: var(--text-color);
        text-decoration: none;
        transition: color 0.3s ease;
      }
      
      .item-title a:hover {
        color: var(--theme-color);
      }
      
      .item-content {
        margin-bottom: 8px;
      }
      
      .property-row {
        display: flex;
        margin-bottom: 4px;
        align-items: flex-start;
        font-size: 11px;
      }
      
      .property-label {
        font-weight: 500;
        color: var(--text-color);
        min-width: 70px;
        flex-shrink: 0;
        opacity: 0.7;
      }
      
      .property-value {
        color: var(--text-color);
        flex: 1;
        word-break: break-word;
      }
      
      .property-value .tag {
        display: inline-block;
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 10px;
        margin-right: 2px;
        margin-bottom: 2px;
        font-weight: 500;
      }
      
      .property-value .checkbox {
        font-size: 1rem;
        font-weight: bold;
      }
      
      .item-footer {
        padding-top: 6px;
        border-top: 1px solid var(--card-border);
        font-size: 10px;
      }
      
      .item-meta {
        display: flex;
        justify-content: space-between;
        font-size: 10px;
        color: var(--font-color);
        opacity: 0.6;
        flex-wrap: wrap;
        gap: 4px;
      }
      
      .item-meta i {
        margin-right: 2px;
      }
      
      .no-data {
        text-align: center;
        padding: 60px 20px;
        color: var(--font-color);
        font-size: 1.1rem;
      }
      
      /* 移动端调整 */
      @media (max-width: 768px) {
        .notion-columns {
          flex-direction: column;
        }
        
        .year-column {
          min-width: 100%;
          max-width: 100%;
        }
        
        .year-header {
          position: static;
        }
      }

    if page.comments !== false && theme.comments && theme.comments.use
      - var commentsJsLoad = true
      !=partial('includes/third-party/comments/index', {}, {cache: true})
