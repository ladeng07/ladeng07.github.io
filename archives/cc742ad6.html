<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>计算机系统工程SecFs实验一 | LMark的博客</title><meta name="author" content="LMark"><meta name="copyright" content="LMark"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言这个学期（大二下）我在郝xd的撺掇下，选了曲老师的《计算机系统工程》这门课。对标的是MIT的6.033课程，参考内容目录MIT6.033 Computer System Design | 计算机系统设计 | Miigon’s blog这门课在国内各大高校同类型的课基本找不到(可能不叫这个名字吧)，就连这本课本的中译版正版都很难找到(我只买到了盗版)。就是这么一门神秘的课程，却讲了许多计算机系统">
<meta property="og:type" content="article">
<meta property="og:title" content="计算机系统工程SecFs实验一">
<meta property="og:url" content="https://lmark.cc/archives/cc742ad6.html">
<meta property="og:site_name" content="LMark的博客">
<meta property="og:description" content="前言这个学期（大二下）我在郝xd的撺掇下，选了曲老师的《计算机系统工程》这门课。对标的是MIT的6.033课程，参考内容目录MIT6.033 Computer System Design | 计算机系统设计 | Miigon’s blog这门课在国内各大高校同类型的课基本找不到(可能不叫这个名字吧)，就连这本课本的中译版正版都很难找到(我只买到了盗版)。就是这么一门神秘的课程，却讲了许多计算机系统">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.lmark.cc/img/300249_origin_20220531_202313.jpg">
<meta property="article:published_time" content="2023-05-07T08:10:59.000Z">
<meta property="article:modified_time" content="2023-09-30T04:06:21.000Z">
<meta property="article:author" content="LMark">
<meta property="article:tag" content="计算机系统工程">
<meta property="article:tag" content="实验">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.lmark.cc/img/300249_origin_20220531_202313.jpg"><link rel="shortcut icon" href="https://cdn.lmark.cc/1633337981355.png"><link rel="canonical" href="https://lmark.cc/archives/cc742ad6.html"><link rel="preconnect" href="https://lib.baomitu.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lib.baomitu.com/font-awesome/6.5.1/css/all.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  infinitegrid: {
    js: 'https://lib.baomitu.com/egjs-infinitegrid/4.11.1/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '计算机系统工程SecFs实验一',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-30 12:06:21'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mycss.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="LMark的博客" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/xlenco/JS-X@main/pace.js/pace.css"/><script src="https://lib.baomitu.com/pace/1.2.4/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">44</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">45</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/Gallery/"><i class="fa-fw fa-solid fa-image"></i><span> 图库</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.lmark.cc/img/300250_origin_20220531_202337.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="LMark的博客"><img class="site-icon" src="https://cdn.lmark.cc/1633337981355.png"/><span class="site-name">LMark的博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/Gallery/"><i class="fa-fw fa-solid fa-image"></i><span> 图库</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">计算机系统工程SecFs实验一</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-07T08:10:59.000Z" title="发表于 2023-05-07 16:10:59">2023-05-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-30T04:06:21.000Z" title="更新于 2023-09-30 12:06:21">2023-09-30</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>34分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title="计算机系统工程SecFs实验一"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这个学期（大二下）我在郝xd的撺掇下，选了曲老师的《计算机系统工程》这门课。对标的是MIT的6.033课程，参考内容目录<a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.miigon.net/posts/mit6033-computer-system-design/">MIT6.033 Computer System Design | 计算机系统设计 | Miigon’s blog</a><br>这门课在国内各大高校同类型的课基本找不到(可能不叫这个名字吧)，就连这本课本的中译版正版都很难找到(我只买到了盗版)。就是这么一门神秘的课程，却讲了许多计算机系统设计的基本原则，可谓是干货满满。用曲老师的话来说:这门课可能是大学四年中，计算机专业最实用的课。在上了半个学期后，我是深深体会到了。故想写一篇博客记录一下这节课的实验课，以及自己的一些想法。</p>
<h2 id="实验背景"><a href="#实验背景" class="headerlink" title="实验背景"></a>实验背景</h2><p>世界正在慢慢变得更加紧密，并且越来越需要让你的所有数据都具有可用性、可共享性、安全性和可 复制性，由于这些需求，Dropbox 和 Google Drive 等云服务应运而生，并取得了巨大成功。他们获取你的 文件并将它们透明地托管在“云”中。但是，用户在此过程中失去了对数据的一些控制。你必须信任公司 能够保证数据安全；你必须相信他们不会查看你的数据，不会共享它，也不会丢失它。在本实验中，要求 开发一个文件系统，这个系统允许用户将数据存储在远程文件服务器上，但是用户无需信任该服务器。</p>
<h2 id="实验介绍"><a href="#实验介绍" class="headerlink" title="实验介绍"></a>实验介绍</h2><p>本实验的目的是让你了解如何构建安全、相对复杂且有用的软件。你将构建一个远程文件系统 SecFS， 它在面对完全不受信任的服务器时能提供机密性和完整性。 我们为你提供了一个具有很少功能和更少安全保证的框架为基础进行本实验。你需要扩展这些功能来 实现线面的实验目标。我们提供的代码是 SUNDR 序列化版本的一部分。你应该阅读论文 SUNDR ，因为本 实验中的许多概念和原理与之相似。为了完成本实验，你需要实现其余部分以支持整个序列化 SUNDR，并 添加机密性保证（文件的读取保护）。</p>
<p>实验官网：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://css.csail.mit.edu/6.858/2020/labs/lab5-2020.html">6.858 Spring 2020 Final assignment (mit.edu)</a></p>
<h2 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h2><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>本实验需要python3环境，这还是有点坑爹的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y python3-venv libfuse-dev python3-dev</span><br></pre></td></tr></table></figure>

<p>然后克隆SecFS文件系统的仓库，并安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/mit-pdos/secfs-skeleton.git secfs</span><br><span class="line">cd secfs</span><br><span class="line">./setup.sh</span><br></pre></td></tr></table></figure>

<p>出现以下提示即说明安装成功，之后只需要使用start.sh即可启动文件系统</p>
<p><img src="https://cdn.lmark.cc/img/image-20230414103810394.png"></p>
<h3 id="文件目录"><a href="#文件目录" class="headerlink" title="文件目录"></a>文件目录</h3><p><img src="https://cdn.lmark.cc/img/image-20230414111518317.png"></p>
<p><img src="https://cdn.lmark.cc/img/image-20230414111557373.png"></p>
<h3 id="代码预览"><a href="#代码预览" class="headerlink" title="代码预览"></a>代码预览</h3><h4 id="secfs-access-py"><a href="#secfs-access-py" class="headerlink" title=".&#x2F;secfs&#x2F;access.py"></a>.&#x2F;secfs&#x2F;access.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> secfs.fs</span><br><span class="line"><span class="keyword">from</span> secfs.types <span class="keyword">import</span> I, Principal, User, Group</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">can_read</span>(<span class="params">user, i</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    如果给定user可以读取给定的i，则返回True。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">can_write</span>(<span class="params">user, i</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    如果给定user可以修改给定的i，则返回True。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(user, User):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not a User, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(user, <span class="built_in">type</span>(user)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(i, I):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not an I, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i, <span class="built_in">type</span>(i)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果i属于某个user，而这个user不是你，你就不能写入</span></span><br><span class="line">    <span class="keyword">if</span> i.p.is_user() <span class="keyword">and</span> i.p != user:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果一个group拥有i，而你不在这个group中，你就不能写入</span></span><br><span class="line">    <span class="keyword">if</span> i.p.is_group() <span class="keyword">and</span> (i.p <span class="keyword">not</span> <span class="keyword">in</span> secfs.fs.groupmap <span class="keyword">or</span> user <span class="keyword">not</span> <span class="keyword">in</span> secfs.fs.groupmap[i.p]):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">can_execute</span>(<span class="params">user, i</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    如果给定user可以执行给定的i，则返回True。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(user, User):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not a User, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(user, <span class="built_in">type</span>(user)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> secfs.access.can_read(user, i):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 校验x位</span></span><br><span class="line">    node = secfs.fs.get_inode(i)</span><br><span class="line">    <span class="keyword">return</span> node.ex</span><br></pre></td></tr></table></figure>

<h4 id="secfs-crypto-py"><a href="#secfs-crypto-py" class="headerlink" title=".&#x2F;secfs&#x2F;crypto.py"></a>.&#x2F;secfs&#x2F;crypto.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 该文件实现了SecFS的加密部分</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.asymmetric <span class="keyword">import</span> padding</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.asymmetric <span class="keyword">import</span> rsa</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives <span class="keyword">import</span> serialization</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives <span class="keyword">import</span> hashes</span><br><span class="line"><span class="keyword">from</span> cryptography.fernet <span class="keyword">import</span> Fernet</span><br><span class="line"><span class="keyword">from</span> secfs.types <span class="keyword">import</span> I, Principal, User, Group</span><br><span class="line"></span><br><span class="line">keys = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register_keyfile</span>(<span class="params">user, f</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    为给定user注册私钥，用于签名/解密。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(user, User):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not a User, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(user, <span class="built_in">type</span>(user)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(f, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> key_file:</span><br><span class="line">        k=key_file.read()</span><br><span class="line">        keys[user] = serialization.load_pem_private_key(</span><br><span class="line">            k,</span><br><span class="line">            password=<span class="literal">None</span>,</span><br><span class="line">            backend=default_backend()</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_sym</span>(<span class="params">key, data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    用给定的密钥解密给定的数据。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    f = Fernet(key)</span><br><span class="line">    <span class="keyword">return</span> f.decrypt(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_sym</span>(<span class="params">key, data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    用给定的密钥加密给定的数据。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    f = Fernet(key)</span><br><span class="line">    <span class="keyword">return</span> f.encrypt(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_key</span>(<span class="params">user</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    确保私钥/公钥存在于指定user的user-$uid-key.pem中，如果没有，请创建一个，并将私钥存储在磁盘上。</span></span><br><span class="line"><span class="string">    最终，返回user的pem编码公钥。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(user, User):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not a User, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(user, <span class="built_in">type</span>(user)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> cryptography.hazmat.primitives.asymmetric <span class="keyword">import</span> rsa</span><br><span class="line">    <span class="keyword">from</span> cryptography.hazmat.primitives <span class="keyword">import</span> serialization</span><br><span class="line">    <span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"></span><br><span class="line">    f = <span class="string">&quot;user-&#123;&#125;-key.pem&quot;</span>.<span class="built_in">format</span>(user.<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">import</span> os.path</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(f):</span><br><span class="line">        private_key = rsa.generate_private_key(</span><br><span class="line">            public_exponent=<span class="number">65537</span>,</span><br><span class="line">            key_size=<span class="number">2048</span>,</span><br><span class="line">            backend=default_backend()</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        pem = private_key.private_bytes(</span><br><span class="line">           encoding=serialization.Encoding.PEM,</span><br><span class="line">           <span class="built_in">format</span>=serialization.PrivateFormat.TraditionalOpenSSL,</span><br><span class="line">           encryption_algorithm=serialization.NoEncryption()</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(f, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> key_file:</span><br><span class="line">            key_file.write(pem)</span><br><span class="line"></span><br><span class="line">        public_key = private_key.public_key()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(f, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> key_file:</span><br><span class="line">            public_key = serialization.load_pem_private_key(</span><br><span class="line">                key_file.read(),</span><br><span class="line">                password=<span class="literal">None</span>,</span><br><span class="line">                backend=default_backend()</span><br><span class="line">            ).public_key()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> public_key.public_bytes(</span><br><span class="line">       encoding=serialization.Encoding.PEM,</span><br><span class="line">       <span class="built_in">format</span>=serialization.PublicFormat.SubjectPublicKeyInfo</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h4 id="secfs-fs-py"><a href="#secfs-fs-py" class="headerlink" title=".&#x2F;secfs&#x2F;fs.py"></a>.&#x2F;secfs&#x2F;fs.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 该文件实现了inode级别的文件系统操作。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> secfs.crypto</span><br><span class="line"><span class="keyword">import</span> secfs.tables</span><br><span class="line"><span class="keyword">import</span> secfs.access</span><br><span class="line"><span class="keyword">import</span> secfs.store.tree</span><br><span class="line"><span class="keyword">import</span> secfs.store.block</span><br><span class="line"><span class="keyword">from</span> secfs.store.inode <span class="keyword">import</span> Inode</span><br><span class="line"><span class="keyword">from</span> secfs.store.tree <span class="keyword">import</span> Directory</span><br><span class="line"><span class="keyword">from</span> cryptography.fernet <span class="keyword">import</span> Fernet</span><br><span class="line"><span class="keyword">from</span> secfs.types <span class="keyword">import</span> I, Principal, User, Group</span><br><span class="line"></span><br><span class="line"><span class="comment"># usermap包含一个从user ID到根据/.users对应的公钥的映射</span></span><br><span class="line">usermap = &#123;&#125;</span><br><span class="line"><span class="comment"># groupmap包含一个从group ID到/.groups的成员列表的映射</span></span><br><span class="line">groupmap = &#123;&#125;</span><br><span class="line"><span class="comment"># owner 是拥有当前共享的user主体</span></span><br><span class="line">owner = <span class="literal">None</span></span><br><span class="line"><span class="comment"># root_i 是当前共享root节点的i</span></span><br><span class="line">root_i = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_inode</span>(<span class="params">i</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    根据inode的i获取inode的快捷方式。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    ihash = secfs.tables.resolve(i)</span><br><span class="line">    <span class="keyword">if</span> ihash == <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> LookupError(<span class="string">&quot;asked to resolve i &#123;&#125;, but i does not exist&quot;</span>.<span class="built_in">format</span>(i))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Inode.load(ihash)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">owner, users, groups</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Init将初始化一个新的共享root作为给定的user主体。这包括在根目录中添加.和..。.users和.groups文件，分别列出可信user公钥和group成员。这个函数只会分配共享的根目录，但不会将它映射到服务器上的任何特定共享。新root节点的i会被返回，这样调用者就可以完成这项工作。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(owner, User):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not a User, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(owner, <span class="built_in">type</span>(owner)))</span><br><span class="line"></span><br><span class="line">    node = Inode()</span><br><span class="line">    node.kind = <span class="number">0</span></span><br><span class="line">    node.ex = <span class="literal">True</span></span><br><span class="line">    node.ctime = time.time()</span><br><span class="line">    node.mtime = node.ctime</span><br><span class="line"></span><br><span class="line">    ihash = secfs.store.block.store(node.<span class="built_in">bytes</span>())</span><br><span class="line">    root_i = secfs.tables.modmap(owner, I(owner), ihash)</span><br><span class="line">    <span class="keyword">if</span> root_i == <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError</span><br><span class="line"></span><br><span class="line">    new_ihash = secfs.store.tree.add(root_i, <span class="string">b&#x27;.&#x27;</span>, root_i)</span><br><span class="line">    secfs.tables.modmap(owner, root_i, new_ihash)</span><br><span class="line">    new_ihash = secfs.store.tree.add(root_i, <span class="string">b&#x27;..&#x27;</span>, root_i)</span><br><span class="line">    secfs.tables.modmap(owner, root_i, new_ihash)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;CREATED ROOT AT&quot;</span>, new_ihash)</span><br><span class="line"></span><br><span class="line">    init = &#123;</span><br><span class="line">        <span class="string">b&quot;.users&quot;</span>: users,</span><br><span class="line">        <span class="string">b&quot;.groups&quot;</span>: groups,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">import</span> pickle</span><br><span class="line">    <span class="keyword">for</span> fn, c <span class="keyword">in</span> init.items():</span><br><span class="line">        bts = pickle.dumps(c)</span><br><span class="line"></span><br><span class="line">        node = Inode()</span><br><span class="line">        node.kind = <span class="number">1</span></span><br><span class="line">        node.size = <span class="built_in">len</span>(bts)</span><br><span class="line">        node.mtime = node.ctime</span><br><span class="line">        node.ctime = time.time()</span><br><span class="line">        node.blocks = [secfs.store.block.store(bts)]</span><br><span class="line"></span><br><span class="line">        ihash = secfs.store.block.store(node.<span class="built_in">bytes</span>())</span><br><span class="line">        i = secfs.tables.modmap(owner, I(owner), ihash)</span><br><span class="line">        link(owner, i, root_i, fn)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> root_i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_create</span>(<span class="params">parent_i, name, create_as, create_for, isdir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    _create分配一个新文件，并将其链接到指定名称的目录parent_i中。新文件由create_for拥有，但使用create_as的凭据创建。这种区别是必要的，因为在作为group创建文件时，最后的i需要user主体。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(parent_i, I):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not an I, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(parent_i, <span class="built_in">type</span>(parent_i)))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(create_as, User):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not a User, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(create_as, <span class="built_in">type</span>(create_as)))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(create_for, Principal):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not a Principal, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(create_for, <span class="built_in">type</span>(create_for)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> create_as.is_user() <span class="comment"># 仅users可创建</span></span><br><span class="line">    <span class="keyword">assert</span> create_as == create_for <span class="keyword">or</span> create_for.is_group() <span class="comment"># 为你自己或group创建</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> create_for.is_group() <span class="keyword">and</span> create_for <span class="keyword">not</span> <span class="keyword">in</span> groupmap:</span><br><span class="line">        <span class="keyword">raise</span> PermissionError(<span class="string">&quot;cannot create for unknown group &#123;&#125;&quot;</span>.<span class="built_in">format</span>(create_for))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 该检查由下面的link()执行，但最好能尽快失败</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> secfs.access.can_write(create_as, parent_i):</span><br><span class="line">        <span class="keyword">if</span> parent_i.p.is_group():</span><br><span class="line">            <span class="keyword">raise</span> PermissionError(<span class="string">&quot;cannot create in group-writeable directory &#123;0&#125; as &#123;1&#125;; user is not in group&quot;</span>.<span class="built_in">format</span>(parent_i, create_as))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> PermissionError(<span class="string">&quot;cannot create in user-writeable directory &#123;0&#125; as &#123;1&#125;&quot;</span>.<span class="built_in">format</span>(parent_i, create_as))</span><br><span class="line"></span><br><span class="line">    node = Inode()</span><br><span class="line">    node.ctime = time.time()</span><br><span class="line">    node.mtime = node.ctime</span><br><span class="line">    node.kind = <span class="number">0</span> <span class="keyword">if</span> isdir <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">    node.ex = isdir</span><br><span class="line"></span><br><span class="line">    <span class="comment"># FIXME</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 在这里，你需要：</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># - 在服务器上存储新创建的 inode (node.bytes())</span></span><br><span class="line">    <span class="comment"># - 将该块映射到user拥有的 i</span></span><br><span class="line">    <span class="comment"># - 如果创建目录，则为之创建条目.和 ..</span></span><br><span class="line">    <span class="comment"># - 如果 create_for 是一个group，您还必须为该group创建一个group i，并将其指向user i</span></span><br><span class="line">    <span class="comment"># - 调用 link() 将新 i 链接到 parent_i 中给定名称的目录</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 还要确保你*返回新 inode 的最终 i*！</span></span><br><span class="line">    <span class="keyword">return</span> I(User(<span class="number">0</span>), <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">parent_i, name, create_as, create_for</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    创建一个新文件。</span></span><br><span class="line"><span class="string">	查看secfs.fs._create</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> _create(parent_i, name, create_as, create_for, <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mkdir</span>(<span class="params">parent_i, name, create_as, create_for</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    创建一个新目录。</span></span><br><span class="line"><span class="string">    查看secfs.fs._create</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> _create(parent_i, name, create_as, create_for, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">read_as, i, off, size</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Read从文件i中读取[off:off+size]字节。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(i, I):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not an I, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i, <span class="built_in">type</span>(i)))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(read_as, User):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not a User, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(read_as, <span class="built_in">type</span>(read_as)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> secfs.access.can_read(read_as, i):</span><br><span class="line">        <span class="keyword">if</span> i.p.is_group():</span><br><span class="line">            <span class="keyword">raise</span> PermissionError(<span class="string">&quot;cannot read from group-readable file &#123;0&#125; as &#123;1&#125;; user is not in group&quot;</span>.<span class="built_in">format</span>(i, read_as))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> PermissionError(<span class="string">&quot;cannot read from user-readable file &#123;0&#125; as &#123;1&#125;&quot;</span>.<span class="built_in">format</span>(i, read_as))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> get_inode(i).read()[off:off+size]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">write_as, i, off, buf</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Write将给定的字节写入文件i的给定偏移量处。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(i, I):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not an I, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i, <span class="built_in">type</span>(i)))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(write_as, User):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not a User, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(write_as, <span class="built_in">type</span>(write_as)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> secfs.access.can_write(write_as, i):</span><br><span class="line">        <span class="keyword">if</span> i.p.is_group():</span><br><span class="line">            <span class="keyword">raise</span> PermissionError(<span class="string">&quot;cannot write to group-owned file &#123;0&#125; as &#123;1&#125;; user is not in group&quot;</span>.<span class="built_in">format</span>(i, write_as))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> PermissionError(<span class="string">&quot;cannot write to user-owned file &#123;0&#125; as &#123;1&#125;&quot;</span>.<span class="built_in">format</span>(i, write_as))</span><br><span class="line"></span><br><span class="line">    node = get_inode(i)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># <span class="doctag">TODO:</span> 这显然是愚蠢的——不应该删除没有更改的块(blocks)</span></span><br><span class="line">    bts = node.read()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># write还允许我们扩展文件</span></span><br><span class="line">    <span class="keyword">if</span> off + <span class="built_in">len</span>(buf) &gt; <span class="built_in">len</span>(bts):</span><br><span class="line">        bts = bts[:off] + buf</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        bts = bts[:off] + buf + bts[off+<span class="built_in">len</span>(buf):]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 更新inode</span></span><br><span class="line">    node.blocks = [secfs.store.block.store(bts)]</span><br><span class="line">    node.mtime = time.time()</span><br><span class="line">    node.size = <span class="built_in">len</span>(bts)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将新的哈希值放入树中</span></span><br><span class="line">    new_hash = secfs.store.block.store(node.<span class="built_in">bytes</span>())</span><br><span class="line">    secfs.tables.modmap(write_as, i, new_hash)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(buf)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readdir</span>(<span class="params">i, off</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    返回目录i中的is的列表。</span></span><br><span class="line"><span class="string">    每个返回的列表项都是一个由i和索引组成的元组。该索引可用于在以后请求该列表的后缀。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    dr = Directory(i)</span><br><span class="line">    <span class="keyword">if</span> dr == <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [(i, index+<span class="number">1</span>) <span class="keyword">for</span> index, i <span class="keyword">in</span> <span class="built_in">enumerate</span>(dr.children) <span class="keyword">if</span> index &gt;= off]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">link</span>(<span class="params">link_as, i, parent_i, name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    将给定的i添加到给定的父目录下。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(parent_i, I):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not an I, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(parent_i, <span class="built_in">type</span>(parent_i)))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(i, I):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not an I, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i, <span class="built_in">type</span>(i)))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(link_as, User):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not a User, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(link_as, <span class="built_in">type</span>(link_as)))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> secfs.access.can_write(link_as, parent_i):</span><br><span class="line">        <span class="keyword">if</span> parent_i.p.is_group():</span><br><span class="line">            <span class="keyword">raise</span> PermissionError(<span class="string">&quot;cannot create in group-writeable directory &#123;0&#125; as &#123;1&#125;; user is not in group&quot;</span>.<span class="built_in">format</span>(parent_i, link_as))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> PermissionError(<span class="string">&quot;cannot create in user-writeable directory &#123;0&#125; as &#123;1&#125;&quot;</span>.<span class="built_in">format</span>(parent_i, link_as))</span><br><span class="line"></span><br><span class="line">    parent_ihash = secfs.store.tree.add(parent_i, name, i)</span><br><span class="line">    secfs.tables.modmap(link_as, parent_i, parent_ihash)</span><br></pre></td></tr></table></figure>

<h4 id="secfs-tables-py"><a href="#secfs-tables-py" class="headerlink" title=".&#x2F;secfs&#x2F;tables.py"></a>.&#x2F;secfs&#x2F;tables.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此文件包含处理 i 映射的解析和修改的所有代码。 这包括组句柄间接和 VSL 验证，因此该文件有些毛茸茸(?)。</span></span><br><span class="line"><span class="comment"># 注意：ihandle 是主体（principle）itable 的hash，它保存从 inumbers（i 的第二部分）到 inode 散列的主体映射。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> secfs.store</span><br><span class="line"><span class="keyword">import</span> secfs.fs</span><br><span class="line"><span class="keyword">from</span> secfs.types <span class="keyword">import</span> I, Principal, User, Group</span><br><span class="line"></span><br><span class="line"><span class="comment"># current_itables代表文件系统的itables的当前视图</span></span><br><span class="line">current_itables = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务器连接句柄在挂载时由 secfs-fuse 传递给我们</span></span><br><span class="line">server = <span class="literal">None</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">_server</span>):</span><br><span class="line">    <span class="keyword">global</span> server</span><br><span class="line">    server = _server</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pre</span>(<span class="params">refresh, user</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    在所有user文件系统操作之前调用，即是在我们获得专有服务器锁之后。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> refresh != <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 刷新 usermap 和 groupmap</span></span><br><span class="line">        refresh()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">push_vs</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> push_vs:</span><br><span class="line">        <span class="comment"># 当创建根目录时，我们不应该推送VS，你可能会想把这个留在这里，把你的post()代码而不是pass放在下面。(?)</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Itable</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    itable保存了一个特定主体的映射，对于user，是从inumber(i元组中的第二个元素)到inode哈希的映射，对于groups，是从inumber到groups的user的i的映射。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.mapping = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">ihandle</span>):</span><br><span class="line">        b = secfs.store.block.load(ihandle)</span><br><span class="line">        <span class="keyword">if</span> b == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        t = Itable()</span><br><span class="line">        t.mapping = pickle.loads(b)</span><br><span class="line">        <span class="keyword">return</span> t</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">bytes</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> pickle.dumps(<span class="variable language_">self</span>.mapping)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resolve</span>(<span class="params">i, resolve_groups = <span class="literal">True</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    将给定的i解析为inode哈希。如果没有设置resolve_groups，则gruop只会被解析给它们的user i，而不会进一步解析。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    特别的，对于某些i=(principle, inumber)，我们首先找到主体的itable，然后找到该表的inumber-th元素，如果主体是user，则返回该元素的值。如果不是，我们将返回一个group i，再次解析它以获得最后一个user设置的ihash来写入group i </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(i, I):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not an I, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i, <span class="built_in">type</span>(i)))</span><br><span class="line"></span><br><span class="line">    principal = i.p</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(principal, Principal):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not a Principal, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(principal, <span class="built_in">type</span>(principal)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> i.allocated():</span><br><span class="line">        <span class="comment"># 有人试图查找一个尚未分配的i</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> current_itables</span><br><span class="line">    <span class="keyword">if</span> principal <span class="keyword">not</span> <span class="keyword">in</span> current_itables:</span><br><span class="line">        <span class="comment"># User还没有一个itable</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span> </span><br><span class="line"></span><br><span class="line">    t = current_itables[principal]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> i.n <span class="keyword">not</span> <span class="keyword">in</span> t.mapping:</span><br><span class="line">        <span class="keyword">raise</span> LookupError(<span class="string">&quot;principal &#123;&#125; does not have i &#123;&#125;&quot;</span>.<span class="built_in">format</span>(principal, i))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 可用性测试</span></span><br><span class="line">    <span class="keyword">if</span> principal.is_group() <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(t.mapping[i.n], I):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;looking up group i, but did not get indirection ihash&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> principal.is_user() <span class="keyword">and</span> <span class="built_in">isinstance</span>(t.mapping[i.n], I):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;looking up user i, but got indirection ihash&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(t.mapping[i.n], I) <span class="keyword">and</span> resolve_groups:</span><br><span class="line">        <span class="comment"># 查找group i</span></span><br><span class="line">        <span class="comment"># 根据间接法</span></span><br><span class="line">        <span class="keyword">return</span> resolve(t.mapping[i.n])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> t.mapping[i.n]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">modmap</span>(<span class="params">mod_as, i, ihash</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    更改或分配i，使它指向ihash。</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    如果i.allocated()为假（即i被创建时没有i-number），将为主体i.p分配一个新的i-number。这个函数很复杂，因为i可能是group i，在这种情况下，我们需要：</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    1.分配一个i作为mod_as</span></span><br><span class="line"><span class="string">    2.分配/更改group i以指向上面的新i</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    modmap返回存在映射的i，如果传递的i没有分配，则填充i.n</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(i, I):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not an I, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i, <span class="built_in">type</span>(i)))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(mod_as, User):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not a User, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(mod_as, <span class="built_in">type</span>(mod_as)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> mod_as.is_user() <span class="comment"># 只有真正的user才能修改</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> mod_as != i.p:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;trying to mod object for &#123;&#125; through &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i.p, mod_as))</span><br><span class="line">        <span class="keyword">assert</span> i.p.is_group() <span class="comment"># 如果不是为了self，那么一定是为了group</span></span><br><span class="line"></span><br><span class="line">        real_i = resolve(i, <span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(real_i, I) <span class="keyword">and</span> real_i.p == mod_as:</span><br><span class="line">            <span class="comment"># 我们最近更新了文件，所以我们只需要更新i。</span></span><br><span class="line">            <span class="comment"># 根本不需要改变group i。</span></span><br><span class="line">            <span class="comment"># 这是一个优化。</span></span><br><span class="line">            i = real_i</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(real_i, I) <span class="keyword">or</span> real_i == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(ihash, I):</span><br><span class="line">                <span class="comment"># 调用者已经为我们完成了工作，所以我们只需要链接group条目。</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;mapping&quot;</span>, i, <span class="string">&quot;to&quot;</span>, ihash, <span class="string">&quot;which again points to&quot;</span>, resolve(ihash))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 为mod_as分配一个新条目，然后继续执行，就好像ihash就是那个新的i。</span></span><br><span class="line">				<span class="comment"># <span class="doctag">XXX:</span>没有必要为此发送两个VS</span></span><br><span class="line">                _ihash = ihash</span><br><span class="line">                ihash = modmap(mod_as, I(mod_as), ihash)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;mapping&quot;</span>, i, <span class="string">&quot;to&quot;</span>, ihash, <span class="string">&quot;which again points to&quot;</span>, _ihash)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 这不是一个 group i!</span></span><br><span class="line">            <span class="comment"># User试图覆盖他们不拥有的东西!</span></span><br><span class="line">            <span class="keyword">raise</span> PermissionError(<span class="string">&quot;illegal modmap; tried to mod i &#123;0&#125; as &#123;1&#125;&quot;</span>.<span class="built_in">format</span>(i, mod_as))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查找或创建主体itable</span></span><br><span class="line">    t = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">global</span> current_itables</span><br><span class="line">    <span class="keyword">if</span> i.p <span class="keyword">not</span> <span class="keyword">in</span> current_itables:</span><br><span class="line">        <span class="keyword">if</span> i.allocated():</span><br><span class="line">            <span class="comment"># 这是出乎意料的;</span></span><br><span class="line">            <span class="comment"># User没有一个itable对象，但给出了一个编号</span></span><br><span class="line">            <span class="keyword">raise</span> ReferenceError(<span class="string">&quot;itable not available&quot;</span>)</span><br><span class="line">        t = Itable()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;no current list for principal&quot;</span>, i.p, <span class="string">&quot;; creating empty table&quot;</span>, t.mapping)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        t = current_itables[i.p]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查找(或分配)我们想要修改的i的编号</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> i.allocated():<span class="comment">#为什么要直接传root_i?这个函数就是为了搞定这个的，因为之前已经</span></span><br><span class="line">        inumber = <span class="number">0</span>	  <span class="comment">#为root_i分配了用户法则和inumber，这里是为同一个用户法则，分配新的inumber，然后建立新的inumber与ihash映射</span></span><br><span class="line">        <span class="keyword">while</span> inumber <span class="keyword">in</span> t.mapping:</span><br><span class="line">            inumber += <span class="number">1</span></span><br><span class="line">        i.allocate(inumber)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> i.n <span class="keyword">not</span> <span class="keyword">in</span> t.mapping:</span><br><span class="line">            <span class="keyword">raise</span> IndexError(<span class="string">&quot;invalid inumber&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 修改这个条目，并将更新后的itable存储回来</span></span><br><span class="line">    <span class="keyword">if</span> i.p.is_group():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;mapping&quot;</span>, i.n, <span class="string">&quot;for group&quot;</span>, i.p, <span class="string">&quot;into&quot;</span>, t.mapping)</span><br><span class="line">    t.mapping[i.n] = ihash <span class="comment"># 对于groups，ihash即是i</span></span><br><span class="line">    current_itables[i.p] = t</span><br><span class="line">    <span class="keyword">return</span> i</span><br></pre></td></tr></table></figure>

<h4 id="secfs-types-py"><a href="#secfs-types-py" class="headerlink" title=".&#x2F;secfs&#x2F;types.py"></a>.&#x2F;secfs&#x2F;types.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Principal</span>:</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">id</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_user</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_group</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Principal</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, uid</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(uid, <span class="built_in">int</span>):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;id &#123;&#125; is not an int, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(uid, <span class="built_in">type</span>(uid)))</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>._uid = uid</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getstate__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="variable language_">self</span>._uid, <span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setstate__</span>(<span class="params">self, state</span>):</span><br><span class="line">        <span class="variable language_">self</span>._uid = state[<span class="number">0</span>]</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">id</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._uid</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_user</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">isinstance</span>(other, User) <span class="keyword">and</span> <span class="variable language_">self</span>._uid == other._uid</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;uid=&#123;&#125;&gt;&quot;</span>.<span class="built_in">format</span>(<span class="variable language_">self</span>._uid)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__hash__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hash</span>(<span class="variable language_">self</span>._uid)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Group</span>(<span class="title class_ inherited__">Principal</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, gid</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(gid, <span class="built_in">int</span>):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;id &#123;&#125; is not an int, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(gid, <span class="built_in">type</span>(gid)))</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>._gid = gid</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getstate__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="variable language_">self</span>._gid, <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setstate__</span>(<span class="params">self, state</span>):</span><br><span class="line">        <span class="variable language_">self</span>._gid = state[<span class="number">0</span>]</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">id</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._gid</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_group</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">isinstance</span>(other, Group) <span class="keyword">and</span> <span class="variable language_">self</span>._gid == other._gid</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;gid=&#123;&#125;&gt;&quot;</span>.<span class="built_in">format</span>(<span class="variable language_">self</span>._gid)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__hash__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hash</span>(<span class="variable language_">self</span>._gid)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">I</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, principal, inumber=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(principal, Principal):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not a Principal, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(principal, <span class="built_in">type</span>(principal)))</span><br><span class="line">        <span class="keyword">if</span> inumber <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(inumber, <span class="built_in">int</span>):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;inumber &#123;&#125; is not an int, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(inumber, <span class="built_in">type</span>(inumber)))</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>._p = principal</span><br><span class="line">        <span class="variable language_">self</span>._n = inumber</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getstate__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="variable language_">self</span>._p, <span class="variable language_">self</span>._n)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setstate__</span>(<span class="params">self, state</span>):</span><br><span class="line">        <span class="variable language_">self</span>._p = state[<span class="number">0</span>]</span><br><span class="line">        <span class="variable language_">self</span>._n = state[<span class="number">1</span>]</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">p</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._p</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">n</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._n</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">allocate</span>(<span class="params">self, inumber</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>._n <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> AssertionError(<span class="string">&quot;tried to re-allocate allocated I &#123;&#125; with inumber &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="variable language_">self</span>, inumber))</span><br><span class="line">        <span class="variable language_">self</span>._n = inumber</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">allocated</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._n <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">isinstance</span>(other, I) <span class="keyword">and</span> <span class="variable language_">self</span>._p == other._p <span class="keyword">and</span> <span class="variable language_">self</span>._n == other._n</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.allocated():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;(&#123;&#125;, &#123;&#125;)&quot;</span>.<span class="built_in">format</span>(<span class="variable language_">self</span>._p, <span class="variable language_">self</span>._n)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(&#123;&#125;, &lt;unallocated&gt;)&quot;</span>.<span class="built_in">format</span>(<span class="variable language_">self</span>._p)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__hash__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.allocated():</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;cannot hash unallocated i &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="variable language_">self</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hash</span>((<span class="variable language_">self</span>._p, <span class="variable language_">self</span>._n))</span><br></pre></td></tr></table></figure>

<h4 id="secfs-store-block-py"><a href="#secfs-store-block-py" class="headerlink" title=".&#x2F;secfs&#x2F;store&#x2F;block.py"></a>.&#x2F;secfs&#x2F;store&#x2F;block.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 该文件处理与SecFS服务器的blob存储的所有交互。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务器连接句柄在装载时由secfs-fuse传递给我们</span></span><br><span class="line">server = <span class="literal">None</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">_server</span>):</span><br><span class="line">    <span class="keyword">global</span> server</span><br><span class="line">    server = _server</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">blob</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    将给定的blob存储在服务器中，并返回内容的hash。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">global</span> server</span><br><span class="line">    <span class="keyword">return</span> server.store(blob)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">chash</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从服务器加载具有给定内容哈希的blob。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">global</span> server</span><br><span class="line">    blob = server.read(chash)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># RPC层将对二进制数据进行base64编码</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;data&quot;</span> <span class="keyword">in</span> blob:</span><br><span class="line">        <span class="keyword">import</span> base64</span><br><span class="line">        blob = base64.b64decode(blob[<span class="string">&quot;data&quot;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> blob</span><br></pre></td></tr></table></figure>

<h4 id="secfs-store-inode-py"><a href="#secfs-store-inode-py" class="headerlink" title=".&#x2F;secfs&#x2F;store&#x2F;inode.py"></a>.&#x2F;secfs&#x2F;store&#x2F;inode.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> secfs.store.block</span><br><span class="line"><span class="keyword">import</span> secfs.crypto</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Inode</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.size = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.kind = <span class="number">0</span> <span class="comment"># 0是目录，1是文件</span></span><br><span class="line">        <span class="variable language_">self</span>.ex = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>.ctime = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.mtime = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.blocks = []</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">ihash</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        根据一个inode的ihandle，加载其相关的所有元信息。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        d = secfs.store.block.load(ihash)</span><br><span class="line">        <span class="keyword">if</span> d == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        n = Inode()</span><br><span class="line">        n.__dict__.update(pickle.loads(d))</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        读取该inode的块内容。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">b&quot;&quot;</span>.join([secfs.store.block.load(b) <span class="keyword">for</span> b <span class="keyword">in</span> <span class="variable language_">self</span>.blocks])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">bytes</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">       序列化该inode并返回相应的字节串。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        b = <span class="variable language_">self</span>.__dict__</span><br><span class="line">        <span class="keyword">return</span> pickle.dumps(b)</span><br></pre></td></tr></table></figure>



<h4 id="secfs-store-tree-py"><a href="#secfs-store-tree-py" class="headerlink" title=".&#x2F;secfs&#x2F;store&#x2F;tree.py"></a>.&#x2F;secfs&#x2F;store&#x2F;tree.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 该文件提供了操作SecFS中的目录的功能。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> secfs.fs</span><br><span class="line"><span class="keyword">import</span> secfs.crypto</span><br><span class="line"><span class="keyword">import</span> secfs.tables</span><br><span class="line"><span class="keyword">import</span> secfs.store.block</span><br><span class="line"><span class="keyword">from</span> secfs.store.inode <span class="keyword">import</span> Inode</span><br><span class="line"><span class="keyword">from</span> secfs.types <span class="keyword">import</span> I, Principal, User, Group</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_under</span>(<span class="params">dir_i, name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    尝试在i处的目录下查找给定名称的文件或目录的i。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(dir_i, I):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not an I, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(dir_i, <span class="built_in">type</span>(dir_i)))</span><br><span class="line"></span><br><span class="line">    dr = Directory(dir_i)</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> dr.children:</span><br><span class="line">        <span class="keyword">if</span> f[<span class="number">0</span>] == name:</span><br><span class="line">            <span class="keyword">return</span> f[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Directory</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    目录用于封送和解封送目录inode的内容。要加载一个目录，必须给出一个i。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, i</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(i, I):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not an I, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i, <span class="built_in">type</span>(i)))</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.inode = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.children = []</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.inode = secfs.fs.get_inode(i)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.inode.kind != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;inode with ihash &#123;&#125; is not a directory&quot;</span>.<span class="built_in">format</span>(secfs.tables.resolve(i)))</span><br><span class="line"></span><br><span class="line">        cnt = <span class="variable language_">self</span>.inode.read()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(cnt) != <span class="number">0</span>:</span><br><span class="line">            <span class="variable language_">self</span>.children = pickle.loads(cnt)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">bytes</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> pickle.dumps(<span class="variable language_">self</span>.children)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">dir_i, name, i</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    更新目录的inode内容，在给定名称下包含一个表示i的项。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(dir_i, I):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not an I, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(dir_i, <span class="built_in">type</span>(dir_i)))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(i, I):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; is not an I, is a &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i, <span class="built_in">type</span>(i)))</span><br><span class="line"></span><br><span class="line">    dr = Directory(dir_i)</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> dr.children:</span><br><span class="line">        <span class="keyword">if</span> f[<span class="number">0</span>] == name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">&quot;asked to add i &#123;&#125; to dir &#123;&#125; under name &#123;&#125;, but name already exists&quot;</span>.<span class="built_in">format</span>(i, dir_i, name))</span><br><span class="line"></span><br><span class="line">    dr.children.append((name, i))</span><br><span class="line">    new_dhash = secfs.store.block.store(dr.<span class="built_in">bytes</span>())</span><br><span class="line">    dr.inode.blocks = [new_dhash]</span><br><span class="line">    new_ihash = secfs.store.block.store(dr.inode.<span class="built_in">bytes</span>())</span><br><span class="line">    <span class="keyword">return</span> new_ihash</span><br></pre></td></tr></table></figure>



<h3 id="实验任务"><a href="#实验任务" class="headerlink" title="实验任务"></a>实验任务</h3><h4 id="（1）Enable-file-directory-creation"><a href="#（1）Enable-file-directory-creation" class="headerlink" title="（1）Enable file&#x2F;directory creation"></a>（1）Enable file&#x2F;directory creation</h4><p>​	在文件 secfs&#x2F;fs.py 中，有一个名为create 的方法，它负责在文件系统中创建新文件和目录，并负责分 配和配置 inode，然后将其存储在服务器上，为新文件设置适当的 i，并将其链接到其父目录。如果你打开 这个文件，你会发现有一部分代码缺失了，缺失的部分用了一个大的 FIXME 注释块标识，解释丢失的代码 应该做什么。 </p>
<p>​	在补写代码之前，你将无法创建新文件或目录，即使是 root，但可以查找现有文件或目录（例如.users 或.groups）。因此，从这里开始我们的实验。 </p>
<p>​	为了补写代码，你首先应该尝试理解 secfs.tables.modmap 函数，这个函数修改 i-tables 将 i 映射为块哈 希。这是 SecFS 的关键函数，并在整个代码中广泛使用。要添加.和 ..，你应该查看 secfs.store.tree.add 函 数, 然后为了链接最后的 i，你将用到 secfs.fs.link 函数 （或者是 link，link 和create 在同一个文件中）。要 在服务器上存储数据，你需要使用相对简单的 secfs.store.block.store 函数。</p>
<p>​	成功实施_create 后，你应该能在文件系统的根目录中以 root 身份创建新文件和目录。</p>
<blockquote>
<p>In the file <code>secfs/fs.py</code>, there is a function called <code>_create</code>. It is used to create new files and directories in the file system, and is responsible for allocating and configuring an inode, storing it on the server, setting up an appropriate <code>i</code> for the new file, and linking it into its parent directory. If you open it up, you will see that a chunk of the code is missing, denoted by a large <code>FIXME</code> comment block explaining what the missing code is supposed to do.</p>
<p>Until this code is filled in, you will be unable to create new files or directories, even as root, but looking up existing ones will work as expected (e.g. <code>.users</code> or <code>.groups</code>). This is therefore a natural place to start your implementation.</p>
<p>In order to write this code, you should first try to build a cursory understanding of the <code>secfs.tables.modmap</code> function, which modifies the <code>i</code>-tables that map <code>i</code>s to block hashes. This is a critical component of SecFS, and is used extensively throughout the code. For adding <code>.</code> and <code>..</code>, you should look at <code>secfs.store.tree.add</code>, and for linking in the final <code>i</code>, you will need to use <code>secfs.fs.link</code> (or just <code>link</code> since <code>_create</code> is in the same file). To store data on the server, you will also need to use the relatively straightforward <code>secfs.store.block.store</code>. You may find <code>secfs.fs.init</code> a useful starting point.</p>
<p>When you have implemented <code>_create</code> successfully, you should be able to create new files and directories as root in the root of the file system. You may also have to come back to this function when you implement multi-user support in Exercise 2 below.</p>
</blockquote>
<h4 id="（2）Multi-client-support"><a href="#（2）Multi-client-support" class="headerlink" title="（2）Multi-client support"></a>（2）Multi-client support</h4><p>你可能已经注意到，在出现第二个客户端之前可以正常运行 test.sh。当第二个客户端尝试访问已挂载 文件系统中的任何文件时，会出现错误：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LookupError: asked to resolve i ((0,False),0), but i does not exist</span><br></pre></td></tr></table></figure>

<p>​	出现错误是因为第二个客户机没有访问文件系统的 i-tables，因为它们目前只存储在第一个客户机的内 存中。在 SUNDR 中，这些 i-tables 被持久保存在服务器上，通过对描述文件系统的版本结构（或 VSes）更 改 i 来更改对用户和组的 i-tables 。这些文件从服务器下载，然后用于验证本地下载的 i-tables。当文件系 统被更改时，一个新的、已签名的 VS 被上传到服务器，以便其他客户端可以看到更改。 </p>
<p>​	具体来说，实验任务 2 是为了能够在单独的挂载点上启动第二个 SecFS 客户机，并能够运行命令 ls -la 来显示.users 和.groups 的文件。要完成本实验，你必须用 SUNDR 的版本结构列表替换 secfs&#x2F;tables.py 中的 current_itables 映射，该映射将用户和组句柄映射到文件哈希（参见论文的第 3.3.2 节）。这个列表必须与 服务器通信，以便其他客户机可以下载它，然后使用这些映射来探索文件系统。 </p>
<p>​	当你可以使用第二个客户机读取文件系统中的文件时，尝试在一个客户机中创建几个文件(以root身份)， 并验证在另一个客户机挂载后运行 ls 时该文件是否出现。</p>
<blockquote>
<p>As you may have noticed, running <code>test.sh</code> works fine until a second client appears. When this second client attempts to access any file in the mounted file system, an error is given:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LookupError: asked to resolve i ((0, False), 0), but i does not exist</span><br></pre></td></tr></table></figure>

<p>This happens because the second client does not have access to the file system’s <code>i</code>-tables, since these are (currently) only stored in the memory of the first client. In SUNDR, these <code>i</code>-tables are persisted on the server, and changes to the <code>i</code>-tables of users and groups are announced through Version Structures (or VSes) that describe <em>changes</em> to the file system. These are downloaded from the server, verified, and then used to verify downloaded <code>i</code>-tables locally. When the file system is changed, a new, signed VS is uploaded to the server, so that other clients can see the change.</p>
<p>Specifically, your goal for the first exercise is to be able to start a second SecFS client (see “Interacting with the file system”) on a separate mount point, and be able to run <code>ls -la</code> to reveal the <code>.users</code> and <code>.groups</code> files. To do so, you will have to replace the <code>current_itables</code> map in <code>secfs/tables.py</code>, which maps user and group handles to file hashes, with SUNDR’s Version Structure List (see section 3.3.2 of the paper). This list must be communicated to the server so that other clients can download it, and then use those mappings to explore the file system.</p>
<p>You may want to first get the list working, and only afterwards add cryptographic signing and verification of the VSes. You should consider implementing your cryptographic operations in <code>secfs/crypto.py</code>. Public keys for users are available in <code>secfs.fs.usermap</code> (key is a <code>User</code>).</p>
<p>When you can read files in the file system using a second client, try to create a few file (as root) in one client, and verify that this file then appears when running <code>ls</code> in the other client’s mountpoint.</p>
</blockquote>
<h4 id="实验提示"><a href="#实验提示" class="headerlink" title="实验提示"></a>实验提示</h4><p>​	实验中会用到 SUNDR 论文中的内容。我们在此处给出了从 SUNDR 论文中的图 2 和图 3 到 SecFS 中 文件的映射：</p>
<table>
<thead>
<tr>
<th align="left">structure</th>
<th align="left">location</th>
</tr>
</thead>
<tbody><tr>
<td align="left">i-tables</td>
<td align="left"><code>secfs/tables.py</code></td>
</tr>
<tr>
<td align="left">inodes</td>
<td align="left"><code>secfs/store/inode.py</code></td>
</tr>
<tr>
<td align="left">directory block</td>
<td align="left"><code>secfs/store/tree.py</code></td>
</tr>
<tr>
<td align="left">version structure</td>
<td align="left">has not been implemented, but should probably replace <code>current_itables</code> in <code>secfs/tables.py</code></td>
</tr>
</tbody></table>
<p>参考文献：inode.pdf——主要介绍了inode和i-table的关系</p>
<h3 id="实验一步骤"><a href="#实验一步骤" class="headerlink" title="实验一步骤"></a>实验一步骤</h3><p>先讲实验一，首先，由之前讲命名的那堂课可以知道，从文件名到磁盘上的块实现访问，需要经过十层间接层，中间就有一层是inode层。我们都知道，一个inode对应一个文件，且每个inode都有一个结点编号，元信息和指向块的指针。这几乎囊括了一个文件的所有信息。</p>
<p>这样我们只需要知道一个目录下有多少个inode编号，就可以知道有多少文件了，如何去高效的查找inode，这就用到了i-table，存有目录下的inode编号。</p>
<p>SUNDR使用i-handle来查找某个用户的i-table，这和实验一关系不大，所以略过不讲。</p>
<p>先来看需要补充的函数上方的init函数</p>
<p><img src="https://cdn.lmark.cc/img/image-20230506104528577.png"></p>
<p>可以看到，首先先给Inode结点分配了ihash，然后给这个ihash建立一个映射给root_i；这个实验主要操作的数据对象就是这个I类型，这个类型是由principal和i-number组成的。</p>
<p>这里的root_i对应的是根目录，因为一个目录下，无论如何都会有两个<code>.和..</code>这两个目录，用于指向父目录和自己，所以同时也需要创建两个文件。这里使用的add方法，也无需了解其实现，只要知道怎么用的就行了，大概就是将某个I对象映射到某个目录下，并起个名字。</p>
<p>这里在获得new_ihash之后，为什么要使用一个modmap映射呢？乍一看这里写的很抽象，我们知道，modmap作用是建立ihash的映射，并且返回一个I对象，这里并没有返回值，这是为什么呢？</p>
<p>其实这是modmap函数的另一个用法，修改i-table里i-number到ihash的映射，因为文件或目录被修改之后，需要重新生成一个ihash，add函数就是给目录增加文件的同时，返回了最新的ihash。</p>
<p>然后就到<code>users</code>和<code>groups</code>文件的生成了，文件的生成和目录是差不多的，主要是少了一步add的步骤。还多了一步link，我们都知道，在Linux文件系统中，文件的只有在连接数为0的时候才会删除，也就是说，增加连接数才会让一个文件出现（？大概）</p>
<p><img src="https://cdn.lmark.cc/img/image-20230506112453558.png"></p>
<p>综上，实验一的参考代码如下：</p>
<p><img src="https://cdn.lmark.cc/img/image-20230506112516514.png"></p>
<h3 id="实验二前瞻"><a href="#实验二前瞻" class="headerlink" title="实验二前瞻"></a>实验二前瞻</h3><p>反反复复看了好多遍实验一和SUNDR，才大概知道实验二要干嘛，我觉得吧，实验二主要是操作current_itables，让不同用户使用自己i-table，还有就是当文件修改后，要及时更新ihash且上传服务器，还有就是版本向量啥的，总之方向大概是这样。</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%B7%A5%E7%A8%8B/">计算机系统工程</a><a class="post-meta__tags" href="/tags/%E5%AE%9E%E9%AA%8C/">实验</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.lmark.cc/img/300249_origin_20220531_202313.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://lib.baomitu.com/butterfly-extsrc/1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://lib.baomitu.com/butterfly-extsrc/1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/archives/83346b50.html" title="武汉游"><img class="cover" src="https://cdn.lmark.cc/img/image-20230509231341633.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">武汉游</div></div></a></div><div class="next-post pull-right"><a href="/archives/646e4863.html" title="自制Amiibo全记录"><img class="cover" src="https://cdn.lmark.cc/img/300257_origin_20220531_202454.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">自制Amiibo全记录</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">LMark</div><div class="author-info__description">一个喜欢折腾有意思的技术的人，但是记性不好，所以博客主要记录曾经掌握的知识，方便日后已经忘记的我回来复习。</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">44</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">45</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/ladeng07"><i class="fab fa-github"></i><span>关注我</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ladeng07" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2312936963@qq.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/34625132" rel="external nofollow noreferrer" target="_blank" title="Bilibili"><i class="fas fa-tv"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss" style="color: #f26522;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E8%83%8C%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">实验背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.</span> <span class="toc-text">实验介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%86%85%E5%AE%B9"><span class="toc-number">4.</span> <span class="toc-text">实验内容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.</span> <span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95"><span class="toc-number">4.2.</span> <span class="toc-text">文件目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E9%A2%84%E8%A7%88"><span class="toc-number">4.3.</span> <span class="toc-text">代码预览</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#secfs-access-py"><span class="toc-number">4.3.1.</span> <span class="toc-text">.&#x2F;secfs&#x2F;access.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#secfs-crypto-py"><span class="toc-number">4.3.2.</span> <span class="toc-text">.&#x2F;secfs&#x2F;crypto.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#secfs-fs-py"><span class="toc-number">4.3.3.</span> <span class="toc-text">.&#x2F;secfs&#x2F;fs.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#secfs-tables-py"><span class="toc-number">4.3.4.</span> <span class="toc-text">.&#x2F;secfs&#x2F;tables.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#secfs-types-py"><span class="toc-number">4.3.5.</span> <span class="toc-text">.&#x2F;secfs&#x2F;types.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#secfs-store-block-py"><span class="toc-number">4.3.6.</span> <span class="toc-text">.&#x2F;secfs&#x2F;store&#x2F;block.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#secfs-store-inode-py"><span class="toc-number">4.3.7.</span> <span class="toc-text">.&#x2F;secfs&#x2F;store&#x2F;inode.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#secfs-store-tree-py"><span class="toc-number">4.3.8.</span> <span class="toc-text">.&#x2F;secfs&#x2F;store&#x2F;tree.py</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.4.</span> <span class="toc-text">实验任务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Enable-file-directory-creation"><span class="toc-number">4.4.1.</span> <span class="toc-text">（1）Enable file&#x2F;directory creation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89Multi-client-support"><span class="toc-number">4.4.2.</span> <span class="toc-text">（2）Multi-client support</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%8F%90%E7%A4%BA"><span class="toc-number">4.4.3.</span> <span class="toc-text">实验提示</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%B8%80%E6%AD%A5%E9%AA%A4"><span class="toc-number">4.5.</span> <span class="toc-text">实验一步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BA%8C%E5%89%8D%E7%9E%BB"><span class="toc-number">4.6.</span> <span class="toc-text">实验二前瞻</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/archives/febc3415.html" title="一次给龙芯旧世界升级内核的失败经历"><img src="https://cdn.lmark.cc/img/300147_origin_20220531_195551.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一次给龙芯旧世界升级内核的失败经历"/></a><div class="content"><a class="title" href="/archives/febc3415.html" title="一次给龙芯旧世界升级内核的失败经历">一次给龙芯旧世界升级内核的失败经历</a><time datetime="2024-03-03T15:47:36.000Z" title="发表于 2024-03-03 23:47:36">2024-03-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/bf37dab6.html" title="在Loongarch下编译Remmina 1.4.5版本"><img src="https://cdn.lmark.cc/img/300172_origin_20220531_200244.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在Loongarch下编译Remmina 1.4.5版本"/></a><div class="content"><a class="title" href="/archives/bf37dab6.html" title="在Loongarch下编译Remmina 1.4.5版本">在Loongarch下编译Remmina 1.4.5版本</a><time datetime="2024-02-29T13:04:38.000Z" title="发表于 2024-02-29 21:04:38">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/a0885322.html" title="关于Django以前忽略的一些东西"><img src="http://cdn.lmark.cc/img/8KTbdUZovNG1DgH.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="关于Django以前忽略的一些东西"/></a><div class="content"><a class="title" href="/archives/a0885322.html" title="关于Django以前忽略的一些东西">关于Django以前忽略的一些东西</a><time datetime="2024-02-27T03:49:26.000Z" title="发表于 2024-02-27 11:49:26">2024-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/b280ab86.html" title="记一次手相简单学习"><img src="https://cdn.lmark.cc/img/300227_origin_20220531_201506.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="记一次手相简单学习"/></a><div class="content"><a class="title" href="/archives/b280ab86.html" title="记一次手相简单学习">记一次手相简单学习</a><time datetime="2023-11-11T08:57:54.000Z" title="发表于 2023-11-11 16:57:54">2023-11-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/ea66db6.html" title="为Loongarch移植thunderbird78版本"><img src="https://cdn.lmark.cc/img/300138_origin_20220531_195238.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="为Loongarch移植thunderbird78版本"/></a><div class="content"><a class="title" href="/archives/ea66db6.html" title="为Loongarch移植thunderbird78版本">为Loongarch移植thunderbird78版本</a><time datetime="2023-10-22T17:45:57.000Z" title="发表于 2023-10-23 01:45:57">2023-10-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2024 By LMark</div><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/" rel="external nofollow noreferrer"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a><a style="margin-inline:5px" target="_blank" href="https://butterfly.js.org/" rel="external nofollow noreferrer"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a><a style="margin-inline:5px" target="_blank" href="https://beian.miit.gov.cn/#/Integrated/index" rel="external nofollow noreferrer"><img src="https://img.shields.io/badge/%E6%A1%82ICP%E5%A4%87-2022004639%E5%8F%B7--1-blue" alt="桂ICP备2022004639号-1" title="本站已在桂进行备案"></a><a style="margin-inline:5px" target="_blank" href="https://github.com/" rel="external nofollow noreferrer"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a><a style="margin-inline:5px" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://lib.baomitu.com/hexo-theme-butterfly/4.13.0/js/utils.min.js"></script><script src="https://lib.baomitu.com/hexo-theme-butterfly/4.13.0/js/main.min.js"></script><script src="https://lib.baomitu.com/medium-zoom/1.1.0/medium-zoom.min.js"></script><script src="https://lib.baomitu.com/instant.page/5.2.0/instantpage.min.js" type="module"></script><script src="https://lib.baomitu.com/node-snackbar/0.1.16/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.lmark.cc/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.lmark.cc/',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))

    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://lib.baomitu.com/twikoo/1.6.39/twikoo.all.min.js').then(init)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo.lmark.cc/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://lib.baomitu.com/twikoo/1.6.39/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><div class="aplayer no-destroy" data-id="7509532357" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true" data-order="random"> </div><link rel="stylesheet" href="https://lib.baomitu.com/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lib.baomitu.com/aplayer/1.10.1/APlayer.min.js"></script><script src="https://lib.baomitu.com/butterfly-extsrc/1.1.3/metingjs/dist/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script></div><!-- hexo injector body_end start --><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 280px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("https://gitcalendar.lmark.cc/api?ladeng07",['#ebedf0', '#f1f8ff', '#dbedff', '#c8e1ff', '#79b8ff', '#2188ff', '#0366d6', '#005cc5', '#044289', '#032f62', '#05264c'],'ladeng07')
    }
  </script><!-- hexo injector body_end end --></body></html>